#!/bin/sh
#   Use rofi to pick emoji because that's what this
#   century is about apparently...
#
#   Requirements:
#     rofi, xclip/wl-copy curl, xmllint
#
#   Usage:
#     1. Download all emoji
#        $ rofi-emoji --download
#
#     2. Run it!
#        $ rofi-emoji
#
#   Notes:
#     * You'll need a emoji font like "Noto Emoji" or "EmojiOne".
#     * Confirming an item will automatically paste it WITHOUT
#       writing it to your clipboard.
#     * Ctrl+C will copy it to your clipboard WITHOUT pasting it.
#
#   Credits:
#     This script is a slightly modified version of:
#     https://gist.github.com/Tadly/0741821d3694deaec1ee454a95c591fa

# Where to save the emojis file.
EMOJI_FILE="$XDG_CACHE_HOME/emojis"

# Urls of emoji to download.
# You can remove what you don't need.
URLS="https://emojipedia.org/people/ \
    https://emojipedia.org/nature/ \
    https://emojipedia.org/food-drink/ \
    https://emojipedia.org/activity/ \
    https://emojipedia.org/travel-places/ \
    https://emojipedia.org/objects/ \
    https://emojipedia.org/symbols/ \
    https://emojipedia.org/flags/"

download() {
    notify-send "$(basename "$0")" "Downloading all emojis for your pleasure"
    echo >"$EMOJI_FILE"

    for url in $URLS; do
        echo "Downloading: $url"
        local emojis

        # Download the list of emoji and remove all the junk around it
        emojis="$(curl -s "$url" \
            | xmllint --html --xpath '//span[@class="emoji"]/..' - 2>/dev/null \
            | sed -rn 's|.*<span class="emoji">(.*)</span> (.*)</a>.*|\1 \2|p')"

        echo "$emojis" >>"$EMOJI_FILE"
    done

    notify-send "$(basename "$0")" "We're all set!"
}

display() {
    local clipCmd emoji emojis line
    emojis="$(grep -v '#' <"$EMOJI_FILE" | grep -v '^[[:space:]]*$')"
    line=$(echo "$emojis" | rofi -dmenu -i -p emoji -no-show-icons)
    if [ $? -eq 0 ]; then
        emoji="${line%%[[:space:]]*}"
        notify-send "'$emoji' copied to clipboard."

        local clipCmd="xclip -sel c"
        [ "$XDG_SESSION_TYPE" = wayland ] && clipCmd="wl-copy"
        echo -n "$emoji" | $clipCmd
    fi
}

# Some simple argparsing
case "$1" in
    -D | --download)
        download
        exit
        ;;
    -h | --help)
        echo "usage: $0 [-D|--download]"
        exit
        ;;
esac

# Download all emoji if they don't exist yet
if [ ! -f "$EMOJI_FILE" ]; then
    download
fi

display
