#!/bin/sh

cache="$XDG_CACHE_HOME/menu-run"

find_commands() {
    find "$@" -type f -executable |
        sed 's|.*/\(.*\)|\1|'
}

update_cache_and_list_commands() {
    if [ -f "$cache" ]; then
        set -- "$@" -newer "$cache"
    fi

    updated_dirs="$(find "$@" -type d)"
    if [ -n "$updated_dirs" ]; then
        temp_file="$(mktemp)"
        # shellcheck disable=2086
        find_commands $updated_dirs | sort -u "$cache" - >"$temp_file" && mv "$temp_file" "$cache"
    fi

    cat "$cache"
}

dirs=$(echo "$PATH" | tr ':' '\n')
# shellcheck disable=2086
exec $(update_cache_and_list_commands $dirs | menu -p "Run:" "$@")
