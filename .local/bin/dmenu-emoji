#!/bin/sh
# Displays a list of emojis to be selected from using dmenu.
#
# This script takes inspiration from:
#   https://gist.github.com/Tadly/0741821d3694deaec1ee454a95c591fa

set -e

# Where to save the emojis file.
EMOJI_FILE="$XDG_CACHE_HOME/emojis"

# URLs of emoji to download.
# You can remove what you don't need.
URLS="https://emojipedia.org/people/ \
    https://emojipedia.org/nature/ \
    https://emojipedia.org/food-drink/ \
    https://emojipedia.org/activity/ \
    https://emojipedia.org/travel-places/ \
    https://emojipedia.org/objects/ \
    https://emojipedia.org/symbols/ \
    https://emojipedia.org/flags/"

notify() {
    notify-send -i emoji-people-symbolic -t 1500 \
        -h string:x-canonical-private-synchronous:emojis \
        "Emoji Prompt" "$@"
}

download() {
    notify "Downloading all emojis for your pleasure"

    for url in $URLS; do
        echo "Downloading: $url"

        # Download the list of emoji and remove all the junk around it
        emojis="$(curl -s "$url" |
            xmllint --html --xpath '//span[@class="emoji"]/..' - 2>/dev/null |
            sed -rn 's|.*<span class="emoji">(.*)</span> (.*)</a>.*|\1 \2|p')"

        echo "$emojis" >>"$EMOJI_FILE"
    done

    notify "We're all set!"
}

# Some simple argparsing
case "$1" in
    -c | --copy)
        MUST_COPY=1
        ;;
    -h | --help)
        echo "usage: $0 [-c|--copy, -h|--help]"
        exit
        ;;
esac

# Download all emojis if they don't exist yet
if [ ! -f "$EMOJI_FILE" ]; then
    download
    exit
fi

emojis="$(grep -v '#' "$EMOJI_FILE" | grep -v '^[[:space:]]*$')"
if line="$(echo "$emojis" | dmenu -l 8 -i -p "Emoji:")"; then
    emoji="${line%%[[:space:]]*}"

    if [ "$MUST_COPY" -gt 0 ]; then
        printf "%s" "$emoji" | xclip -sel clipboard &&
            notify "'$emoji' copied to clipboard."
        exit
    fi

    xdotool type "$emoji"
fi
