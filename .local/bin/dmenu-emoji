#!/bin/sh
# Displays a list of emojis to be selected from using dmenu.
#
# This script takes inspiration from:
#   https://gist.github.com/Tadly/0741821d3694deaec1ee454a95c591fa

set -e

# Where to save the emojis file.
EMOJI_FILE="$XDG_CACHE_HOME/emojis"
URL="https://unicode.org/emoji/charts/emoji-list.html"

notify() {
    notify-send -i emoji-people-symbolic -t 1500 \
        -h string:x-canonical-private-synchronous:emojis \
        "Emoji Prompt" "$@"
}

download() {
    notify "Downloading emojis for your pleasure"

    # Scrape emoji metadata from the webpage
    curl -s "$URL" |
        xmllint --html --xpath '//td[@class="andr"]/a/img/@title' - 2>/dev/null |
        sed 's/^ title="\(U+[0-9,A-Z]* \)*\([^ ]*\) \(.*\)"/\2 \u\3/; s/\&amp;/and/' >"$EMOJI_FILE"

    notify "We're all set!"
}

# Some simple argparsing
case "$1" in
    -c | --copy)
        MUST_COPY=1
        ;;
    -h | --help)
        echo "usage: $0 [-c|--copy, -h|--help]"
        exit
        ;;
esac

# Download all emojis if they don't exist yet
if [ ! -f "$EMOJI_FILE" ]; then
    download
    exit
fi

emojis="$(grep -v '#' "$EMOJI_FILE" | grep -v '^[[:space:]]*$')"
if line="$(echo "$emojis" | dmenu -l 8 -i -p "Emoji:")"; then
    emoji="${line%%[[:space:]]*}"

    if [ "$MUST_COPY" -gt 0 ]; then
        printf "%s" "$emoji" | xclip -sel clipboard &&
            notify "'$emoji' copied to clipboard."
        exit
    fi

    xdotool type "$emoji"
fi
