#!/bin/sh

type_it=0
if [ "$1" = "--type" ]; then
    type_it=1
    shift
fi

choice=$(rbw list --fields=name,user,folder | awk -F'\t' '{
    printf "/"
    if ($3 != "") printf "%s/", $3
    printf "%s/%s\n", $1, $2
}' | menu -p "Password:" -i -l 5 "$@")

[ -n "$choice" ] || exit

old_ifs="$IFS"
IFS='/'
# shellcheck disable=SC2086
set -- $choice
IFS="$old_ifs"
shift # Get rid of leading empty field.

# If the chosen secret is contained in a folder, then move its argument to the back.
if [ $# -eq 3 ]; then
    folder="$1"
    shift
    set -- --folder "$folder" "$@"
fi

if [ $type_it -eq 0 ]; then
    rbw get --clipboard "$@"
else
    rbw get --field=password "$@" |
        case "$XDG_SESSION_TYPE" in
            x11) xdotool type --clearmodifiers --file - ;;
            wayland) wtype - ;;
        esac
fi
