#!/bin/sh

pidFile=/tmp/record

recordRegion() {
	# Selection was cancelled
	[ -z "$1" ] && return

    file="$(date '+%Y-%m-%d_%H.%M.%S').mp4"
    path="$HOME/videos/recordings/$file"

    if [ "$XDG_SESSION_TYPE" = "wayland" ]; then
        wf-recorder -f "$path" -g "$1" >/tmp/record.log 2>&1 &
    else
        read -r W H X Y << EOF
`echo $1 | tr '[x+]' ' '`
EOF
        args="-f x11grab -s ${W}x${H} -r 60 -i $DISPLAY+$X,$Y"

        # Use NVENC if GPU is in "compute" mode
        if [ "$(supergfxctl -g)" = "compute" ]; then
            args="$args -c:v h264_nvenc"
        fi

        ffmpeg $args "$path" >/tmp/record.log 2>&1 &
    fi

	echo "file=$file;pid=$!" > $pidFile
}

if [ -f $pidFile ]; then
	# Stop recording if PID file exists
	. $pidFile
	kill -INT $pid
	wait $pid

	notify-send -i screenshot "Record" "The recording has been successfully saved as $file."
	rm $pidFile
else
	# Start recording
    recordRegion "$(sel-area)"
fi

pkill -RTMIN+27 $STATUSBAR
