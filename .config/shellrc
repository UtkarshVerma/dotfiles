#!/bin/sh

shell=""
[ -n "$ZSH_VERSION" ] && shell=zsh
[ -n "$BASH_VERSION" ] && shell=bash

se() {
    bin_dir="$HOME/.local/bin"
    cat <<EOF | sed "s|$bin_dir/||g" | fzf | sed "s|^|$bin_dir/|g" | xargs -r "$EDITOR"
$(find "$bin_dir/" -type l -xtype f)
$(find "$bin_dir/statusbar/" -type f)
EOF

    unset bin_dir
}

dpaste() {
    if url="$(curl --silent --form 'format=url' --form 'content=<-' \
        "https://dpaste.org/api/")"; then
        printf "%s" "$url" | xclip -selection clipboard &&
            echo "URL \"$url\" copied to clipboard."
    fi

    unset url
}

emit_osc7_sequence() {
    temp="$PWD"
    encoded=""
    while [ -n "$temp" ]; do
        n="${temp#?}"
        c="${temp%"$n"}"
        case "$c" in
            [-/:_.!\'\(\)~[:alnum:]]) encoded="$encoded$c" ;;
            *) encoded="${encoded}$(printf '%%%02X' "$c")" ;;
        esac
        temp="$n"
    done
    unset n c

    printf "\033]7;file://%s%s\033\\" "$(hostname)" "$encoded"

    unset temp encoded
}

cd() {
    if type __zoxide_z >/dev/null 2>&1; then
        __zoxide_z "$@"
    else
        command cd "$@"
    fi || return $?

    emit_osc7_sequence
}

scripts="$XDG_CONFIG_HOME/aliasrc
    $XDG_CONFIG_HOME/lf/lf.sh
    $XDG_CONFIG_HOME/yazi/yazicd.sh
    /opt/ros/noetic/setup.sh
    /usr/bin/virtualenvwrapper_lazy.sh"

echo "$scripts" | while read -r script; do
    if [ -f "$script" ]; then
        # shellcheck disable=1090
        . "$script"
    fi
done
unset scripts

# direnv shell integration.
if command -v direnv >/dev/null 2>&1; then
    export DIRENV_LOG_FORMAT="" # Silence direnv

    case "$shell" in
        zsh) eval "$(direnv hook zsh)" ;;
        bash) eval "$(direnv hook bash)" ;;
    esac
fi

# fzf shell integration.
if command -v fzf >/dev/null 2>&1; then
    case "$shell" in
        zsh) eval "$(fzf --zsh)" ;;
        bash) eval "$(fzf --bash)" ;;
    esac
fi

# zoxide shell integration.
if command -v zoxide >/dev/null 2>&1; then
    case "$shell" in
        zsh) eval "$(zoxide init zsh --no-cmd)" ;;
        bash) eval "$(zoxide init bash --no-cmd)" ;;
    esac
    alias cdi=__zoxide_zi
fi

# Update CWD on launch.
emit_osc7_sequence

unset shell
